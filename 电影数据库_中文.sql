SET LANGUAGE N'简体中文';
CREATE DATABASE 电影数据库;
GO
USE 电影数据库;
GO
-------------------------------------------------------------------
-- 1) 创建表
CREATE TABLE 电影 (
    电影编号 INT IDENTITY(1,1) PRIMARY KEY, 
    片名 NCHAR(60) NOT NULL,             
    上映年份 SMALLINT NOT NULL CHECK (上映年份 >= 0),
    语言 NCHAR(50) NOT NULL,             
    时长 SMALLINT NOT NULL CHECK (时长 >= 0), 
    国家 NCHAR(50) NOT NULL,       
    字幕 NCHAR(3) NOT NULL CHECK (字幕 IN ('是', '否')), 
    年龄限制 NCHAR(4) NOT NULL CHECK (年龄限制 IN ('16', '18', '12', '无'))
);
-------------------------------------------------------------------
CREATE TABLE 演员 (
    演员编号 INT IDENTITY(1,1) PRIMARY KEY,
    名字 NCHAR(50) NOT NULL,
    姓氏 NCHAR(50) NOT NULL,
    性别 NCHAR(1) NOT NULL CHECK (性别 = '男' OR 性别 = '女'),
    出生日期 DATE,
    国籍 NCHAR(50),
    出生地 NCHAR(50)
);
-------------------------------------------------------------------
CREATE TABLE 导演 (
    导演编号 INT IDENTITY(1,1) PRIMARY KEY,
    名字 NCHAR(50) NOT NULL,
    姓氏 NCHAR(50) NOT NULL,
    性别 NCHAR(1) NOT NULL CHECK (性别 = '男' OR 性别 = '女'),
    出生日期 DATE,
    国籍 NCHAR(50),
    出生地 NCHAR(50)
);
-------------------------------------------------------------------
CREATE TABLE 角色 (
    演员编号 INT NOT NULL,
    电影编号 INT NOT NULL,
    角色名称 NCHAR(50) NOT NULL,
    CONSTRAINT 角色_演员 FOREIGN KEY (演员编号) REFERENCES 演员(演员编号)
    ON DELETE NO ACTION,
    CONSTRAINT 角色_电影 FOREIGN KEY (电影编号) REFERENCES 电影(电影编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 电影导演 (
    导演编号 INT NOT NULL,
    电影编号 INT NOT NULL,
    CONSTRAINT 电影导演_导演 FOREIGN KEY (导演编号) REFERENCES 导演(导演编号)
    ON DELETE NO ACTION,
    CONSTRAINT 电影导演_电影 FOREIGN KEY (电影编号) REFERENCES 电影(电影编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 类型 (
    类型编号 INT IDENTITY(1,1) PRIMARY KEY,
    名称 NCHAR(40) NOT NULL UNIQUE
);
-------------------------------------------------------------------
CREATE TABLE 电影类型 (
    电影编号 INT NOT NULL,
    类型编号 INT NOT NULL,
    CONSTRAINT 电影类型_电影 FOREIGN KEY (电影编号) REFERENCES 电影(电影编号)
    ON DELETE NO ACTION,
    CONSTRAINT 电影类型_类型 FOREIGN KEY (类型编号) REFERENCES 类型(类型编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 影厅 (
    影厅编号 INT IDENTITY(1,1) PRIMARY KEY,
    影厅名称 NCHAR(25) NOT NULL UNIQUE
);
-------------------------------------------------------------------
CREATE TABLE 放映场次 (
    场次编号 INT IDENTITY(1,1) PRIMARY KEY,
    电影编号 INT NOT NULL,
    影厅编号 INT NOT NULL,
    放映时间 SMALLDATETIME NOT NULL,
    CONSTRAINT 放映场次_电影 FOREIGN KEY (电影编号) REFERENCES 电影(电影编号)
    ON DELETE NO ACTION,
    CONSTRAINT 放映场次_影厅 FOREIGN KEY (影厅编号) REFERENCES 影厅(影厅编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 排列 (
    排列编号 INT IDENTITY(1,1) PRIMARY KEY,
    排列标签 CHAR NOT NULL CHECK (排列标签 IN ('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N')) UNIQUE
);
-------------------------------------------------------------------
CREATE TABLE 座位 (
    座位编号 INT IDENTITY(1,1) PRIMARY KEY,
    座位号 INT NOT NULL CHECK (座位号 BETWEEN 1 AND 20) UNIQUE
);
-------------------------------------------------------------------
CREATE TABLE 座位位置 (
    座位位置编号 INT IDENTITY(1,1) PRIMARY KEY,
    影厅编号 INT NOT NULL,
    排列编号 INT NOT NULL,
    座位编号 INT NOT NULL,
    CONSTRAINT 座位位置_影厅 FOREIGN KEY (影厅编号) REFERENCES 影厅(影厅编号)
    ON DELETE NO ACTION,
    CONSTRAINT 座位位置_排列 FOREIGN KEY (排列编号) REFERENCES 排列(排列编号)
    ON DELETE NO ACTION,
    CONSTRAINT 座位位置_座位 FOREIGN KEY (座位编号) REFERENCES 座位(座位编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 个人信息 (
    个人信息编号 INT IDENTITY(1,1) PRIMARY KEY,
    名字 NCHAR(50) NOT NULL,
    姓氏 NCHAR(50) NOT NULL,
    出生日期 DATE NOT NULL,
    电子邮件 NCHAR(50) CHECK (电子邮件 LIKE '%@%.%')
);
-------------------------------------------------------------------
CREATE TABLE 顾客 (
    顾客编号 INT IDENTITY(1,1) PRIMARY KEY,
    个人信息编号 INT NOT NULL,
    CONSTRAINT 顾客_个人信息 FOREIGN KEY (个人信息编号)
    REFERENCES 个人信息(个人信息编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
CREATE TABLE 票 (
    票编号 INT IDENTITY(1,1) PRIMARY KEY,
    放映场次编号 INT NOT NULL,
    顾客编号 INT NOT NULL,
    座位位置编号 INT NOT NULL,
    购买日期 SMALLDATETIME NOT NULL,
    CONSTRAINT 票_放映场次 FOREIGN KEY (放映场次编号) REFERENCES 放映场次(场次编号)
    ON DELETE NO ACTION,
    CONSTRAINT 票_顾客 FOREIGN KEY (顾客编号) REFERENCES 顾客(顾客编号)
    ON DELETE NO ACTION,
    CONSTRAINT 票_座位位置 FOREIGN KEY (座位位置编号) REFERENCES 座位位置(座位位置编号)
    ON DELETE NO ACTION
);
-------------------------------------------------------------------
INSERT INTO 电影 (片名, 上映年份, 语言, 时长, 国家, 字幕, 年龄限制)
VALUES ('杰克建造的房子', 2018, '英语', 1555, '丹麦', N'是', N'18'),
       ('泰坦尼克号', 1997, '英语', 194, '美国', '是', '16'),
       ('阿凡达', 2009, '英语', 162, '美国', '是', '12'),
       ('华尔街之狼', 2013, '英语', 180, '美国', '是', '18'),
       ('角斗士', 2000, '英语', 120, '美国', '是', '16'),
       ('飞行家', 2004, '英语', 116, '美国', '是', '12'),
       ('最后的武士', 2003, '英语', 143, '美国', '是', '16'),
       ('阴风阵阵', 2018, '英语', 108, '美国', '是', '18'),
       ('星际穿越', 2014, '英语', 155, '美国', '是', '12'),
       ('肖申克的救赎', 1994, '英语', 142, '美国', '是', '无');
-------------------------------------------------------------------
INSERT INTO 演员 (名字, 姓氏, 性别, 出生日期, 国籍, 出生地)  
VALUES ('Christian', 'Bale', '男', '1974-01-30', '美国', '哈弗福德韦斯特'),  
('Matthew', 'McConaughey', '男', '1969-11-04', '美国', '尤瓦尔迪'),  
('Leonardo', 'DiCaprio', '男', '1974-11-11', '美国', '洛杉矶'),  
('Brad', 'Pitt', '男', '1963-12-18', '美国', '肖尼'),  
('Naomi', 'Watts', '女', '1968-09-28', '英国', '肖勒姆'),  
('Kate', 'Winslet', '女', '1975-10-05', '英国', '雷丁'),  
('Russell', 'Crowe', '男', '1964-04-07', '澳大利亚', '惠灵顿'),  
('Morgan', 'Freeman', '男', '1937-06-01', '美国', '孟菲斯');
-------------------------------------------------------------------
INSERT INTO 导演 (名字, 姓氏, 性别, 出生日期, 国籍, 出生地)  
VALUES ('Steven', 'Spielberg', '男', '1946-12-18', '美国', '辛辛那提'),  
('David', 'Lynch', '男', '1946-01-20', '美国', '米苏拉'),  
('Christopher', 'Nolan', '男', '1970-07-30', '英国', '威斯敏斯特'),  
('James', 'Cameron', '男', '1954-08-16', '加拿大', '卡普斯卡辛'),  
('Ridley', 'Scott', '男', '1937-11-30', '英国', '南希尔兹');  
-------------------------------------------------------------------
INSERT INTO 角色 (演员编号 ,电影编号, 角色名称)  
VALUES (2, 9, 'Cooper'),  
(2, 4, 'Mark Hanna'),  
(3, 2, 'Jack Dawson'),  
(3, 4, 'Jordan Belfort'),  
(3, 6, 'Howard Hughes'),  
(6, 2, 'Rose Bukater'),  
(8, 10, 'Red');  
-------------------------------------------------------------------
INSERT INTO 电影导演 (导演编号, 电影编号)  
VALUES (3, 9),  
(4, 2),  
(4, 3),  
(5, 5);  
-------------------------------------------------------------------
INSERT INTO 个人信息 (名字, 姓氏, 出生日期, 电子邮件)  
VALUES ('Marian', 'Nowak', '1990-10-10', 'marian_nowak@gmail.com'),  
('Tomasz', 'Kwiatkowski', '1980-12-14', 't_kwiatkowski@gmail.com'),  
('Jan', 'Lewandowski', '1995-12-22', 'jan_lewandowski223@gmail.com'),  
('Marcin', 'Nowak', '1992-10-10', 'marcin_nowak92@gmail.com'),  
('Marian', 'Kwiatkowski', '1991-10-15', 'marian_kwiatkowski@o2.com'),  
('Michał', 'Piątek', '1994-10-10', 'mpiatek@gmail.com'),  
('Marcin', 'Gryza', '1992-09-10', 'marcing92@o2.com');  
-------------------------------------------------------------------
INSERT INTO 顾客 (个人信息编号)  
VALUES (1),  
(2),  
(3),  
(4),  
(5),  
(6),  
(7);  
-------------------------------------------------------------------
INSERT INTO 类型 (名称)  
VALUES ('剧情'),  
('恐怖'),  
('科幻'),  
('惊悚'),  
('喜剧'),  
('情节剧'),  
('纪录片'),  
('心理'),  
('动作'),  
('奇幻');  
-------------------------------------------------------------------
INSERT INTO 电影类型 (电影编号 ,类型编号)  
VALUES (1, 8),  
(2, 6),  
(3, 10),  
(4, 5),  
(5, 1),  
(6, 1),  
(7, 1),  
(8, 2),  
(9, 1),  
(10, 3);  
-------------------------------------------------------------------
INSERT INTO 排列 (排列标签)  
VALUES ('A'),  
('B'),  
('C'),  
('D'),  
('E'),  
('F'),  
('G'),  
('H'),  
('I'),  
('J'),  
('K'),  
('L'),  
('M'),  
('N');  
-------------------------------------------------------------------
INSERT INTO 座位 (座位号)  
VALUES (20),  
(11),  
(14),  
(15),  
(1),  
(5),  
(3),  
(12),  
(16),  
(6),  
(4),  
(2),  
(7),  
(9),  
(19),  
(18); 
-------------------------------------------------------------------
INSERT INTO 影厅 (影厅名称)  
VALUES ('多伦多'),  
('伦敦'),  
('华沙'),  
('罗马'),  
('纽约'),  
('北京'),  
('布鲁塞尔'),  
('阿姆斯特丹');  
-------------------------------------------------------------------
INSERT INTO 座位位置 (影厅编号, 排列编号, 座位编号)  
VALUES (1,1,1),  
(2,2,2),  
(3,3,3),  
(4,4,5),  
(5,5,4),  
(6,6,7),  
(7,7,6),  
(1,8,8),  
(2,9,9),  
(3,10,10),  
(4,11,11),  
(5,12,12),  
(6,13,13),  
(7,14,14);  
-------------------------------------------------------------------
INSERT INTO 放映场次 (电影编号 ,影厅编号 ,放映时间)  
VALUES (1,2, '2018-02-01 12:00:00'),  
(2,1, '2018-02-01 12:30:00'),  
(2,3, '2018-02-03 12:00:00'),  
(3,2, '2018-02-04 14:30:00'),  
(5,1, '2018-02-03 16:00:00'),  
(4,3, '2018-02-03 17:30:00'),  
(7,2, '2018-02-09 20:00:00'),  
(9,4, '2018-02-04 23:30:00'),  
(5,4, '2018-02-05 12:00:00'),  
(2,1, '2018-02-04 20:00:00'),  
(4,2, '2018-02-05 23:15:00');
-------------------------------------------------------------------
INSERT INTO 票 (放映场次编号, 顾客编号, 座位位置编号, 购买日期)  
VALUES (1, 4, 1, '2018-01-22 20:00:00'),  
(2, 5, 2, '2018-01-24 12:00:00'),  
(3, 6, 3, '2018-01-23 12:00:00'),  
(4, 7, 4, '2018-01-22 23:00:00'),  
(5, 1, 5, '2018-01-26 22:00:00'),  
(6, 2, 6, '2018-01-23 16:00:00'),  
(7, 3, 7, '2018-01-28 18:00:00'),  
(8, 4, 8, '2018-01-30 20:00:00'),  
(9, 5, 9, '2018-01-22 17:00:00'),  
(10, 3, 10, '2018-01-25 20:00:00'),  
(8, 2, 11, '2018-01-23 16:00:00'),  
(8, 6, 12, '2018-01-28 18:00:00'),  
(2, 1, 13, '2018-01-30 20:00:00'),  
(1, 2, 14, '2018-01-22 17:00:00'),  
(8, 3, 1, '2018-01-25 20:00:00'),  
(11, 4, 2, '2018-01-27 20:00:00');  
-------------------------------------------------------------------
--打印出电子邮件包含 'o2' 的人员表。
select 个人信息.名字 as 名字,
	   个人信息.姓氏 as 姓氏,
	   个人信息.电子邮件 as 电子邮件
from 个人信息
where 个人信息.电子邮件 LIKE '%o2%'
order by 个人信息.名字 asc
-------------------------------------------------------------------
--打印出观看电影 '星际穿越' 的人员信息。
select 个人信息.名字 as 名字,
	   个人信息.姓氏 as 姓氏,
	   电影.片名 as 电影,
	   放映场次.放映时间 as 放映时间
from 个人信息
join 顾客  on  个人信息.个人信息编号 = 顾客.个人信息编号
join 票    on  顾客.顾客编号 = 票.顾客编号
join 放映场次 on 票.放映场次编号= 放映场次.场次编号
join 电影  on  放映场次.电影编号 = 电影.电影编号
where 电影.片名 = '星际穿越'
order by 个人信息.名字 asc
-------------------------------------------------------------------
--查看属于戏剧和喜剧类别的电影放映时间。
select 电影.片名 as 电影,
	   类型.名称 as 类型,
	   放映场次.放映时间 as 放映时间
from 放映场次
join 电影 on 放映场次.电影编号 = 电影.电影编号
join 电影类型 on 电影.电影编号 = 电影类型.电影编号
join 类型 on 电影类型.类型编号 = 类型.类型编号
where 类型.名称 = '剧情' or 类型.名称 = '喜剧'
order by 放映场次.放映时间 asc;
-------------------------------------------------------------------
--确定介于两个特定日期之间的电影放映时间表。
select 电影.片名 as 电影 ,
       影厅.影厅名称 as 影厅,
	   类型.名称 as 类型,
	   datename(weekday, 放映场次.放映时间) '星期',
	   放映场次.放映时间 as 放映时间
from 放映场次
join 电影 on 放映场次.电影编号 = 电影.电影编号
join 电影类型 on 电影.电影编号 = 电影类型.电影编号
join 类型 on 电影类型.类型编号 = 类型.类型编号
join 影厅 on  放映场次.影厅编号 = 影厅.影厅编号 
where 放映场次.放映时间 between '2018-02-03' and '2018-02-05' 
order by 放映场次.放映时间 asc;
-------------------------------------------------------------------
--统计每个人观看的电影数量
select 个人信息.名字 as 名字,
	   个人信息.姓氏 as 姓氏,
	   个人信息.出生日期 as 出生日期,
	   个人信息.电子邮件 as 电子邮件, 
	   count(放映场次.电影编号) as '放映次数'
from 个人信息
join 顾客 on 个人信息.个人信息编号 =  顾客.个人信息编号
join 票 on  顾客.顾客编号 = 票.顾客编号
join 放映场次 on 票.放映场次编号 = 放映场次.场次编号
join 电影 on 放映场次.电影编号 = 电影.电影编号
group by 个人信息.名字, 个人信息.姓氏, 个人信息.出生日期, 个人信息.电子邮件
order by 个人信息.名字 asc;
-------------------------------------------------------------------
--统计客户的电影票预订信息
select 个人信息.名字 as 名字,
       个人信息.姓氏 as 姓氏,
	   电影.片名 as 片名,
	   format(放映场次.放映时间,'MM - dd') as '月 - 日',
	   format(放映场次.放映时间,'MM - dd') as '时间',
	   座位.座位号 as '座位号',
       排列.排列标签 as '排列'	   
from 个人信息
join 顾客 on 个人信息.个人信息编号 =  顾客.个人信息编号
join 票 on  顾客.顾客编号 = 票.顾客编号
join 放映场次 on 票.放映场次编号 = 放映场次.场次编号
join 电影 on 放映场次.电影编号 = 电影.电影编号
join 座位位置 on 票.座位位置编号 = 座位位置.座位位置编号
join 座位 on 座位位置.座位编号 =  座位.座位编号
join 排列 on 排列.排列编号 = 座位位置.排列编号
order by 个人信息.名字 asc
-------------------------------------------------------------------
select * from [dbo].[电影]
select * from [dbo].[演员]
select * from [dbo].[导演]
select * from [dbo].[角色]
select * from [dbo].[电影导演]
select * from [dbo].[个人信息]
select * from [dbo].[顾客]
select * from [dbo].[类型]
select * from [dbo].[电影类型]
select * from [dbo].[排列]
select * from [dbo].[座位]
select * from [dbo].[影厅]
select * from [dbo].[座位位置]
select * from [dbo].[放映场次]
select * from [dbo].[票]

